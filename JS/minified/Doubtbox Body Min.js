function $doubtBox(e){timestamp=e.timestamp||"absolute",username=e.username||"default",defaultUsername=e.defaultUsername||null,typeOfID=e.typeOfID||"default",avatar=e.avatar||"default",allowMarkup=e.allowMarkup||"bb",customMarkup=e.customMarkup||'<div class="doubtboxMessage"><span class="dbMsgInnerWrap"><img class="dbUserAvatar"><span class="dbEditControl">[edit]</span><span class="dbDelControl">[X]</span><span class="dbMsgTime"></span><span class="dbMsgUser"><a></a></span><span class="dbMsgBodyWrap"><p class="dbMsgBody"></p></span></span></div>',channels=e.channels||["Chat"],defaultChannel=e.defaultChannel||"Chat",volumeLevels=e.volumeLevels||[1,.4,0],shoutPerPage=e.shoutPerPage||20,invertFlow=e.invertFlow||null,refreshType=e.refreshType||"interval",refreshBase=e.refreshBase||5e3,refreshDecay=e.refreshDecay||1e3,refreshDecayReset=e.refreshDecayReset||20,settingsStorage=e.settingsStorage||null,shoutSource=e.shoutSource||"/index.php?act=Shoutbox";var t=0,o=0,s=0,n=0,r=[];let d=document.getElementById("doubtfulBigChonk");new MutationObserver(function(e,t){for(var a of e){for(var o=0;o<a.removedNodes.length;o++){var s=$(a.removedNodes[o]).attr("messageid"),n=r.indexOf(s);s&&-1!=n&&(console.log("Watcher log: nod removal: ",s," at ",n,r),n=n==r.length-1?-1:n,r.splice(n,1))}for(o=0;o<a.addedNodes.length;o++)if(!$(a.addedNodes[o]).hasClass("doubtbox-ghost")){var d=$(a.addedNodes[o]).attr("messageid");d>0&&-1==r.indexOf(d)&&r.push(d),console.log("Watcher log: node addition: ",d,r)}}}).observe(d,{childList:!0});const i=e=>new Promise(t=>setTimeout(t,e));function l(){window.clearTimeout(sbTimer),sbTimer=null}function u(e,o){$(".doubtbox-refresh div").addClass("rotating"),s++,function(e,t){fetch(e).then(e=>e.text()).then(e=>{let a=new DOMParser,o=a.parseFromString(e,"text/html"),s=[];var n=$(".dbHistoryBack");n.is(":visible")&&$(o).find('form[name="DShoutbox"] p:last a').length?n.show():n.hide();for(var r=$(o).find('form[name="DShoutbox"]').children("div:not(.pformstrip)"),d=0;d<r.length;d++){let e=$(r[d]).find("div:eq(1) span"),t={};try{var i=JSON.parse(e.html());if(7!=Object.keys(i).length)throw"Parsed message has invalid key counts: "+e.text()}catch(t){var l=e.html(),i={};l=l.substring(2,l.length-2),i.timestamp=l.substring(l.indexOf('"timestamp":""')+13,l.indexOf('","',l.indexOf('"timestamp":"')+13)),i.channel=l.substring(l.indexOf('"channel":"')+11,l.indexOf('","',l.indexOf('"channel":"')+11)),i.username=l.substring(l.indexOf('"username":"')+12,l.indexOf('","',l.indexOf('"username":"')+12)),i.userID=l.substring(l.indexOf('"userID":"')+10,l.indexOf('","',l.indexOf('"userID":"')+10)),i.group=l.substring(l.indexOf('"group":"')+9,l.indexOf('","',l.indexOf('"group":"')+9)),i.avatar=l.substring(l.indexOf('"avatar":"')+10,l.indexOf('","',l.indexOf('"avatar":"')+10)),i.content=l.substring(l.indexOf('"content":"')+11)}let a=$(r[d]).find(".post1:last-of-type"),o=a.children("a").eq(1);"default"==username?t.username=o.text():t.username=i.username,"default"==avatar?t.avatar=a.prev().children("img").attr("src"):t.avatar=i.avatar,"default"==typeOfID?t.userID=o.attr("href").slice(o.attr("href").lastIndexOf("=")+1):t.userID=i.userID,t.group=i.group,t.channel=i.channel,t.content=i.content,t.timestamp=i.timestamp,t.messageID=a.children("a").eq(0).text().substring(1),s.push(t)}t(s)})}(o?shoutSource+"&start="+o:shoutSource,function(d){if(s>1)for(var c=0;c<d.length;c++){var f=d[c],p=f.content.length.toString(),m=f.username||"",x=f.avatar||"",v=f.channel||"",M=$('.doubtboxMessage[messageid="'+f.messageID+'"]');if(M.length>0&&!M.hasClass("doubtbox-ghost")&&M.attr("chksum")!==JSON.stringify(f).length){var I=[];p!==M.attr("chksum")&&I.push("content"),m!=M.find(".dbMsgUser").text()&&I.push("username"),x!=M.find(".dbUserAvatar").attr("src")&&I.push("avatar"),v!==M.attr("channel")&&I.push("channel"),I.length>0&&(console.log(I),h(f,function(e){for(var t=0;t<I.length;t++)switch(I[t]){case"content":M.find(".dbMsgBody").replaceWith(e.find(".dbMsgBody"));break;case"username":M.find(".dbMsgUser a").text(f.username);break;case"avatar":M.find(".dbUserAvatar").attr("src",f.avatar);break;case"channel":M.attr("channel",f.channel)}M.attr("chksum",f.content.length)}))}}var S=[];for(c=0;c<d.length;c++)S.push(d[c].messageID);var y=S.slice(0);if(invertFlow?(r.sort((e,t)=>e-t),y.sort((e,t)=>e-t)):(r.sort((e,t)=>t-e),y.sort((e,t)=>t-e)),console.log("pre-flight check: ",r,y),r.length==S.length&&r.every((e,t)=>e===y[t]))t++,console.log("nothing new found;");else{if(t=0,s>1&&!o){console.log("selective");var D=[];$(".doubtboxMessage:not(.doubtbox-ghost)").each(function(){D.push($(this).attr("messageID"))});var k=S.filter(e=>!D.includes(e)),w=D.filter(e=>!S.includes(e)),C=d.filter(e=>k.includes(e.messageID));console.log(D,k,C),console.log("---------------"),console.log(w),k<=0&&(e="silent");for(c=0;c<w.length;c++)$('.doubtboxMessage[messageid="'+w[c]+'"]').fadeToRemove();invertFlow&&C.reverse(),C.forEach(function(t){h(t,function(o){$(".doubtbox-ghost").each(function(){$(this).find(".dbMsgTime").attr("time")==t.timestamp&&($(this).attr("messageid",t.messageID).removeClass("doubtbox-ghost"),$(this).find(".dbEditControl, .dbDelControl").attr("mid",t.messageID),$(this).find(".dbMsgBody").replaceWith(o.find(".dbMsgBody")),o=$(this))}),invertFlow?(orderedSet=S.sort((e,t)=>e-t),a=orderedSet.indexOf(t.messageID),console.log(orderedSet,a,t.messageID),a>=$(".doubtboxMessage").length?o.insertBefore(".dbStatusMessage"):0==a?o.prependTo("#doubtfulBigChonk"):(o.insertAfter('.doubtboxMessage[messageid="'+orderedSet[a-1]+'"]'),console.log("placing ",t.messageID," at ",$('.doubtboxMessage[messageid="'+orderedSet[a-1]+'"]')))):(orderedSet=S.sort((e,t)=>t-e),a=orderedSet.indexOf(t.messageID),console.log(orderedSet,a,t.messageID),a>=$(".doubtboxMessage").length?o.insertBefore(".dbStatusMessage"):0==a?o.prependTo("#doubtfulBigChonk"):(o.insertBefore('.doubtboxMessage[messageid="'+orderedSet[a+1]+'"]'),console.log("placing ",t.messageID," at ",$('.doubtboxMessage[messageid="'+orderedSet[a+1]+'"]')))),"silent"!=e&&channels&&$('.doubtbox-tab:not(.doubtbox-tab-active)[tab="'+t.channel+'"]').addClass("doubtbox-new-messages")}),$(".doubtbox-tab-active").attr("tab")==t.channel&&b()})}else console.log("full refresh!"),$(".doubtboxMessage").remove(),$(".dbStatusMessage").text("Hm. There doesn't seem to be anything here.."),d.forEach(function(e){h(e,function(e){invertFlow?$(e).prependTo("#doubtfulBigChonk"):$(e).insertBefore(".dbStatusMessage")})});s>=1&&r.length>0&&"silent"!=e&&$(".doubtbox-audio")[0].play()}$(".doubtbox-refresh div").removeClass("rotating"),s<=1&&function(){i(500).then(()=>{b(!0)}),"default"==username?$("input#dbUserInput").hide():defaultUsername.length>0&&$("input#dbUserInput").val(defaultUsername);"default"==avatar&&$("input#dbUrlInput").val(doubtboxAvatar).hide();for(var e=0;e<channels.length;e++)$('<span class="doubtbox-tab" tab="'+channels[e]+'">'+channels[e]+"</span>").appendTo("#doubtboxChannelRow");var t;if($(".dbHistoryForward").attr("jump",0-shoutPerPage),$(".dbHistoryBack").attr("jump",shoutPerPage),"cache"==settingsStorage)localStorage.getItem("doubtboxPreferences")&&(t=JSON.parse(localStorage.getItem("doubtboxPreferences"))),$(window).on("beforeunload",function(){let e={};e.fontSize=$(".doubtboxWrapper").attr("text"),e.boxSize=[$(".doubtboxWrapper").width(),$(".doubtboxWrapper").height()],e.volume=$(".doubtbox-volume").attr("level"),e.username=$("#dbUserInput").val(),e.avatar=$("#dbUrlInput").val(),e.channel=$(".doubtbox-tab-active").attr("tab"),localStorage.setItem("doubtboxPreferences",JSON.stringify(e))});else if(-1!=settingsStorage.indexOf("field")){if(doubtboxPreferences)try{t=JSON.parse($("<div></div>").html(doubtboxPreferences).text())}catch(e){console.log(e),t=""}$(".doubtbox-control-row").prepend($('<span class="doubtbox-save-status"></span><span class="doubtbox-save-pref">Save Preferences</span>')),$(document).on("click",".doubtbox-save-pref",function(){let e={};e.fontSize=$(".doubtboxWrapper").attr("text"),e.boxSize=[$(".doubtboxWrapper").width(),$(".doubtboxWrapper").height()],e.volume=$(".doubtbox-volume").attr("level"),e.username=$("#dbUserInput").val(),e.avatar=$("#dbUrlInput").val(),e.channel=$(".doubtbox-tab-active").attr("tab"),fetch("/index.php?act=UserCP&CODE=01").then(e=>e.text()).then(t=>{let a=new DOMParser,o=a.parseFromString(t,"text/html"),s={};$.each($(o).find('form[name="theForm"]').serializeArray(),function(){s[this.name]=this.value});let n=new FormData;for(var r in s)n.append(r,s[r]);n.set(settingsStorage,JSON.stringify(e)),console.log(n.get(settingsStorage)),fetch("/index.php?auth_key="+doubtboxAuth,{method:"POST",body:n}).then(e=>e.text()).then(e=>{let t=new DOMParser,a=t.parseFromString(e,"text/html");$(a).find("#redirect-screen").length>0?$(".doubtbox-save-status").text("Saved!").show(function(){$(".doubtbox-save-status").fadeOut(1200)}):$(".doubtbox-save-status").text("Failed!").show(function(){$(".doubtbox-save-status").fadeOut(1200)})})})})}""!=t?($(".doubtboxWrapper").attr("text",t.fontSize).css("font-size",t.fontSize+"em").width(t.boxSize[0]).height(t.boxSize[1]),$(".doubtbox-volume").attr("level",t.volume),n=volumeLevels.indexOf(parseFloat(t.volume)),$(".doubtbox-audio")[0].volume=t.volume,$("#dbUserInput").val(t.username),$("#dbUrlInput").val(t.avatar),"cache"!=defaultChannel&&$('.doubtbox-tab[tab="'+defaultChannel+'"]').length>0?($('.doubtbox-tab[tab="'+defaultChannel+'"]').trigger("click"),console.log("1",$('.doubtbox-tab[tab="'+defaultChannel+'"]'))):"cache"==defaultChannel&&$('.doubtbox-tab[tab="'+t.channel+'"]').length>0&&($('.doubtbox-tab[tab="'+t.channel+'"]').trigger("click"),console.log("2",$('.doubtbox-tab[tab="'+t.channel+'"]')))):($(".doubtbox-tab:first").trigger("click"),console.log("3",$(".doubtbox-tab:first")))}(),"relative"==timestamp&&$(".dbMsgTime").each(function(){$(this).text(g($(this).attr("time")))}),"interval"==refreshType&&0==$("#doubtboxPageRow").attr("index")&&(t>=refreshDecayReset&&(t=0),window.sbTimer=null,null!=sbTimer?l():(window.clearTimeout(sbTimer),sbTimer=window.setTimeout(u,refreshBase+refreshDecay*t)))})}function b(e){let t=document.getElementById("doubtfulBigChonk");var a,o=document.querySelectorAll(".doubtboxMessage:not(.doubtbox-hidden)"),s=t.scrollHeight,n=t.offsetHeight,r=t.scrollTop;a=o.length?invertFlow?o[o.length-1].scrollHeight:o[0].scrollHeight:0,invertFlow?(console.log("scroling inverted"),(n+r>=s-a+5||e)&&$("#doubtfulBigChonk").stop().animate({scrollTop:s},800)):(console.log("scrolling LIKE A NORMAL GODDAMN HUMAN BEING"),(r<=a+5||e)&&$("#doubtfulBigChonk").stop().animate({scrollTop:0},800))}function c(e){console.log(allowMarkup);var t,a=document.createElement("div"),o=document.createDocumentFragment();switch(a.innerHTML=e,allowMarkup){case"bb":t=e;break;case"html":for(var s=0;s<a.childNodes.length;s++){3===(n=a.childNodes[s].cloneNode(!0)).nodeType?o.appendChild(document.createRange().createContextualFragment(n.nodeValue)):o.appendChild(document.createTextNode(n.innerText))}t=o;break;case"both":case"none":for(s=0;s<a.childNodes.length;s++){var n;3===(n=a.childNodes[s].cloneNode(!0)).nodeType?o.appendChild(document.createRange().createContextualFragment(n.nodeValue)):o.appendChild(n)}t=o}return t=DOMPurify.sanitize(t),console.log("the message is ",t),t}function h(e,t){var a=$.parseHTML(customMarkup),o=$(a);o.attr("sb-gid",e.group).attr("sb-mid",e.userID).attr("channel",e.channel).attr("messageID",e.messageID).attr("chksum",e.content.length).attr("history",JSON.stringify(e)),e.channel!=$(".doubtbox-tab-active").attr("tab")&&o.addClass("doubtbox-hidden"),""==e.userID||"0"==e.userID?(o.find(".dbMsgUser a").remove(),$('<span class="doubtboxGuest"></span>').text(e.username).appendTo(o.find(".dbMsgUser"))):o.find(".dbMsgUser a").attr("href","/index.php?showuser="+e.userID).text(e.username),"none"===allowMarkup?(console.log(c(e.content)),o.find(".dbMsgBody").text(c(e.content))):(console.log(e.messageID," running"),o.find(".dbMsgBody").append(c(e.content))),o.find(".dbUserAvatar").attr("src",DOMPurify.sanitize(e.avatar)),o.find(".dbMsgTime").attr("time",e.timestamp).text(g(e.timestamp)),o.find(".dbEditControl, .dbDelControl").attr("mid",e.messageID),t(o)}function g(e){var t=new Date(parseInt(e)),a=t.toLocaleString("en-gb",{day:"numeric",month:"short",year:"2-digit"})+", "+t.toLocaleString("en-gb",{hour12:!0,hour:"numeric",minute:"numeric"});if("relative"==timestamp){var o,s=(Date.now()-new Date(parseInt(e)))/1e3;switch(s=Math.sign(s)<0?0:s,!0){case s<60:o=parseInt(s)+" "+(1==s?"second":"seconds")+" ago";break;case s<3600:o=parseInt(s/60)+" "+(s/60<=2?"minute":"minutes")+" ago";break;case s<86400:o=parseInt(s/3600)+" "+(s/3600<=2?"hour":"hours")+" ago";break;case s<604800:o=parseInt(s/86400)+" "+(s/86400<=2?"day":"days")+" ago";break;case s<1814400:o=parseInt(s/604800)+" "+(s/604800<=2?"week":"weeks")+" ago";break;default:o=a}}else o=a;return o}$.fn.fadeToRemove=function(){$(this).fadeOut(400,function(){$(this).remove()})},$(".doubtbox-size-larger").click(function(){var e=parseFloat($(".doubtboxWrapper").attr("text"));$(".doubtboxWrapper").attr("text",e+.2).css("font-size",e+.2+"em")}),$(".doubtbox-size-smaller").click(function(){var e=parseFloat($(".doubtboxWrapper").attr("text"));$(".doubtboxWrapper").attr("text",e-.2).css("font-size",e-.2+"em")}),$(".doubtbox-refresh").click(function(){l(),u()}),$(".doubtbox-volume").click(function(e){++n>volumeLevels.length-1&&(n=0),$(".doubtbox-audio")[0].volume=volumeLevels[n],$(e.target).attr("level",volumeLevels[n])}),$(".dbHistoryBack, .dbHistoryForward").click(function(e){o+=parseInt($(e.target).attr("jump")),$("#doubtboxPageRow").attr("index",o),o<=0?(o=0,t=0):l(),u("silent",o)}),$(document).on("click",".doubtbox-tab",function(){$(".doubtbox-tab-active").removeClass("doubtbox-tab-active"),$(this).addClass("doubtbox-tab-active").removeClass("doubtbox-new-messages"),$(".doubtboxMessage.doubtbox-hidden").removeClass("doubtbox-hidden"),$('.doubtboxMessage:not(.doubtboxMessage[channel="'+$(this).attr("tab")+'"])').addClass("doubtbox-hidden")}),$("#dbSendBtn").click(function(){var e={};e.timestamp=Date.now().toString(),e.channel=$(".doubtbox-tab-active").attr("tab")||"",e.username=$("#dbUserInput").val(),e.username||(e.username="\x3c!-- |name| --\x3e"),"parent"==typeOfID&&parseInt("\x3c!-- |parent_id| --\x3e")>0?e.userID="\x3c!-- |parent_id| --\x3e":e.userID="\x3c!-- |id| --\x3e",e.group="\x3c!-- |g_id| --\x3e","default"==avatar?e.avatar=doubtboxAvatar||"":e.avatar=$("#dbUrlInput").val()||"",e.content=$("#dbMsgInput").val(),$("#dbMsgInput").val()?(h(e,function(e){$(e).addClass("doubtbox-ghost"),invertFlow?$(e).insertBefore(".dbStatusMessage"):$("#doubtfulBigChonk").prepend(e)}),$.post("/index.php?act=Shoutbox&submit=Shout",{Post:JSON.stringify(e)}).done(function(){l(),$("#doubtboxPageRow").attr("index",0),$("#dbMsgInput").val(""),u("silent"),b(!0)})):alert("Please enter a message")}),$(document).on("click",".dbEditControl",function(){$(this).hide(),l();var e=$(this).parents(".doubtboxMessage");$('<span class="doubtbox-edit-channel" contenteditable>'+e.attr("channel")+"</span>").insertBefore($(this)),$('<span class="doubtbox-edit-confirm">Confirm</span><span class="doubtbox-edit-cancel">Discard</span>').appendTo(e),e.addClass("doubtbox-editing"),e.find(".dbMsgUser a").attr("contenteditable",!0).on("click",function(e){e.preventDefault()}),e.find(".dbMsgBody").attr("contenteditable",!0),e.find(".dbUserAvatar").click(function(){$('<div class="doubtbox-editing-url"><input type="text" value="'+$(this).attr("src")+'"><div class="doubtbox-url-accept">Confirm</div><div class="doubtbox-url-reset">Discard</div></div>').prependTo(e)})}),$(document).on("click",".doubtbox-url-accept",function(){$(this).parents(".doubtboxMessage").find(".dbUserAvatar").attr("src",$(this).siblings("input").val()),$(this).parent("div").fadeToRemove()}),$(document).on("click",".doubtbox-url-reset",function(){$(this).parent("div").fadetoRemove()}),$(document).on("click",".dbDelControl",function(){confirm("Delete this shout?")&&(l(),$.post("/index.php?&act=Shoutbox&sbmod=03&sid="+$(this).attr("mid")),$(this).parents(".doubtboxMessage").fadeToRemove(),u("silent"))}),$(document).on("click",".doubtbox-edit-confirm",function(){let e=$(this).parents(".doubtboxMessage"),t=JSON.parse(e.attr("history")),a=e.attr("messageid");delete t.messageID,t.content=e.find(".dbMsgBody").text(),t.username=e.find(".dbMsgUser").text(),t.avatar=e.find(".dbUserAvatar").attr("src"),t.channel=e.find(".doubtbox-edit-channel").text();var o=new FormData;o.append("Post",JSON.stringify(t)),o.append("submit","Edit Shout"),$.ajax("/index.php?act=Shoutbox&sbmod=05&sid="+a,{type:"POST",processData:!1,contentType:!1,data:o}).done(function(t){$(t).find(".postcolor").text().length>0?confirm($(t).find(".postcolor").text()):e.find(".doubtbox-edit-cancel").trigger("click")})}),$(document).on("click",".doubtbox-edit-cancel",function(){var e=$(this).parents(".doubtboxMessage");e.removeClass("doubtbox-editing"),e.find(".doubtbox-edit-confirm, .doubtbox-edit-cancel, .doubtbox-editing-url, .doubtbox-edit-channel").fadeToRemove(),e.find(".dbMsgUser a, .dbMsgBody").attr("contenteditable",!1).off(),e.find(".dbEditControl").fadeIn(400),l(),u("silent")}),$("#dbMsgInput").keydown(function(e){13==(e.keyCode||e.which)&&$("#dbSendBtn").trigger("click")}),u(),console.log("944")}$doubtBox({timestamp:"relative",username:"custom",defaultUsername:"\x3c!-- |field_1| --\x3e",typeOfID:"parent",avatar:"default",allowMarkup:"bb",customMarkup:'<div class="doubtboxMessage"><span class="dbMsgInnerWrap"><img class="dbUserAvatar"><span class="dbEditControl">[edit]</span><span class="dbDelControl">[X]</span><span class="dbMsgTime"></span><span class="dbMsgUser"><a></a></span><span class="dbMsgBodyWrap"><p class="dbMsgBody"></p></span></span></div>',channels:["Announcements","Out of Character","In-character"],defaultChannel:"cache",volumeLevels:[1,.4,0],shoutPerPage:10,invertFlow:!1,refreshType:"interval",refreshBase:5e3,refreshDecay:2e3,refreshDecayReset:10,settingsStorage:"field_20",shoutSource:"/index.php?act=Shoutbox"});
